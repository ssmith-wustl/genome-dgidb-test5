#! /gsc/bin/perl

use strict;
use warnings;

use above 'Genome';

use Data::Dumper 'Dumper';
use Test::More;

$ENV{UR_DBI_NO_COMMIT} = 1;
$ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;

use_ok('Genome::Sample::Command::Import::Dacc') or die;

UR::DataSource->next_dummy_autogenerated_id;
do {
    $UR::DataSource::last_dummy_autogenerated_id = int($UR::DataSource::last_dummy_autogenerated_id / 10);
} until length($UR::DataSource::last_dummy_autogenerated_id) < 9;
diag('Dummy ID: '.$UR::DataSource::last_dummy_autogenerated_id);
cmp_ok(length($UR::DataSource::last_dummy_autogenerated_id), '<',  9, 'dummy id is shorter than 9 chars');

# xml file import
my $dir = '/gsc/var/cache/testsuite/data/Genome-InstrumentData-Command-Dacc/SRS000000';
my @xml_files = glob($dir.'/*xml');
is(@xml_files, 2, 'Got 2 xml files');
note('xml file import');
my $sample_name = 'SRS000000';
my $library_name = $sample_name.'-extlibs';
my $import = Genome::Sample::Command::Import::Dacc->create(
    sra_sample_id => $sample_name,
    xml_files => \@xml_files,
);
ok($import, 'create');
$import->dump_status_messages(1);
ok($import->execute, 'execute');

my $individual_name = 'dbGaP-241763';
is($import->_individual->name, $individual_name, 'individual name');
is($import->_sample->name, $sample_name, 'sample name');
is($import->_library->name, $library_name, 'library name');

# basic import
note('basic import');
$import = Genome::Sample::Command::Import::Dacc->create(
    sra_sample_id => $sample_name,
);
ok($import, 'create');
$import->dump_status_messages(1);
ok($import->execute, 'execute');

$individual_name = 'dbGaP-'.$sample_name;
is($import->_individual->name, $individual_name, 'individual name');
is($import->_sample->name, $sample_name, 'sample name');
is($import->_library->name, $library_name, 'library name');

done_testing();
exit;

