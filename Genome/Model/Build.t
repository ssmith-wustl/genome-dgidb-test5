#!/gsc/bin/perl

use strict;
use warnings;

use above 'Genome';

use Test::More tests => 10;

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    use_ok('Genome::Model::Build');
}

my $temp_dir = File::Temp::tempdir(CLEANUP => 1);
my $bogus_id = 0;
my $pp = Genome::ProcessingProfile->create_mock(
                                                id => --$bogus_id,
                                                type_name => 'imported reference sequence',
                                            );
my $model = Genome::Model->create_mock(
                                       name => 'test_model_name',
                                       id => --$bogus_id,
                                       genome_model_id => $bogus_id,
                                       processing_profile_id => $pp->id,
                                       subject_name => 'test_subject_name',
                                       subject_type => 'test_subject_type',
                                       data_directory => $temp_dir,
                                       type_name => $pp->type_name,
                                   );
my $build = Genome::Model::Build->create(
                                         model_id => $model->id,
                                     );
isa_ok($build,'Genome::Model::Build');
is($build->data_directory,$temp_dir .'/build'. $build->id,'build directory resolved');
is($build->model->id,$model->id,'indirect model accessor');

my $build_w_data_dir = Genome::Model::Build->create(
                                                    model_id => $model->id,
                                                    data_directory => $temp_dir,
                                                );
isa_ok($build_w_data_dir,'Genome::Model::Build');
is($build_w_data_dir->data_directory,$temp_dir,'build directory resolved');


my @idas = $build->instrument_data_assignments;
ok(!scalar(@idas),'no instrument data assignments');


my $mock_idas_lt = Genome::Model::InstrumentDataAssignment->__define__(
                                                                   id => $model->id .' '. --$bogus_id,
                                                                   model_id => $model->id,
                                                                   instrument_data_id => $bogus_id,
                                                                   first_build_id => ($build->id - 1),
                                                               );
my $mock_idas_eq = Genome::Model::InstrumentDataAssignment->__define__(
                                                                   id => $model->id .' '. --$bogus_id,
                                                                   model_id => $model->id,
                                                                   instrument_data_id => $bogus_id,
                                                                   first_build_id => $build->id,
                                                               );
my $mock_idas_gt = Genome::Model::InstrumentDataAssignment->__define__(
                                                                   id => $model->id .' '. --$bogus_id,
                                                                   model_id => $model->id,
                                                                   instrument_data_id => $bogus_id,
                                                                   first_build_id => ($build->id + 1),
                                                               );
@idas = $build->instrument_data_assignments;
is(scalar(@idas),2,'two instrument data assignments found');
for my $ida (@idas) {
    ok($ida->first_build_id <= $build->id,'instrument data first_build_id less than build_id');
}

1;
